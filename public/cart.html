<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#2ecc71">
  <title>Ratu Fresh ‚Äì ‡§Ü‡§™‡§ï‡§æ ‡§ï‡§æ‡§∞‡•ç‡§ü üõí</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2ecc71;
      --primary-dark: #27ae60;
      --secondary: #3498db;
      --tertiary: #e74c3c;
      --text-dark: #2c3e50;
      --text-light: #7f8c8d;
      --border-color: #ecf0f1;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      --bg-light: #f5f7fa;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: var(--text-dark);
      min-height: 100vh;
      padding-bottom: 100px;
    }

    /* ============= NAVBAR ============= */
    nav {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 16px 20px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .brand-tagline {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      letter-spacing: 0.5px;
      flex: 1;
      text-align: center;
    }

    .back-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateX(-3px);
    }

    .cart-badge {
      background: #ff4d4d;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
    }

    /* ============= POPUP ============= */
    .popup {
      position: fixed;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: #fff;
      padding: 16px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: var(--shadow);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      text-align: center;
      max-width: 90%;
    }

    .popup.show {
      bottom: 30px;
      opacity: 1;
    }

    .popup.error {
      background: var(--tertiary);
    }

    /* ============= MAIN SECTION ============= */
    .cart-section {
      max-width: 900px;
      margin: 0 auto;
      padding: 25px 15px;
    }

    .section-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .section-header h2 {
      font-size: 28px;
      color: var(--text-dark);
      margin-bottom: 8px;
    }

    .section-subtitle {
      font-size: 13px;
      color: var(--text-light);
    }

    /* ============= CART ITEMS ============= */
    .cart-items {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 25px;
    }

    .cart-item {
      background: #fff;
      border-radius: 12px;
      padding: 18px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      animation: slideIn 0.5s ease-out;
      gap: 12px;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .cart-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    .item-emoji {
      font-size: 28px;
      flex-shrink: 0;
    }

    .item-info {
      flex: 1;
      min-width: 0;
    }

    .item-name {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 4px;
    }

    .item-qty {
      font-size: 13px;
      color: var(--text-light);
    }

    .item-price-section {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-shrink: 0;
    }

    .item-price {
      text-align: right;
      font-size: 16px;
      font-weight: 800;
      color: var(--primary);
      min-width: 60px;
    }

    .item-remove {
      background: linear-gradient(135deg, var(--tertiary) 0%, #c0392b 100%);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .item-remove:hover {
      transform: scale(1.08);
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    /* ============= EMPTY CART ============= */
    .empty-cart {
      background: #fff;
      border-radius: 12px;
      padding: 60px 20px;
      text-align: center;
      box-shadow: var(--shadow);
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .empty-cart h3 {
      font-size: 22px;
      color: var(--text-dark);
      margin-bottom: 10px;
    }

    .empty-cart p {
      color: var(--text-light);
      margin-bottom: 20px;
      font-size: 15px;
    }

    .empty-cart button {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 700;
      transition: all 0.3s ease;
    }

    .empty-cart button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
    }

    /* ============= SUMMARY BOX ============= */
    .cart-summary {
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .summary-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .summary-label {
      color: var(--text-light);
      font-weight: 500;
    }

    .summary-value {
      color: var(--text-dark);
      font-weight: 700;
    }

    .summary-total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-top: 2px solid var(--primary);
      margin-top: 12px;
      font-size: 18px;
      font-weight: 800;
      color: var(--primary);
    }

    /* ============= DELIVERY SECTION ============= */
    .delivery-section {
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .delivery-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .delivery-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }

    .info-item {
      background: var(--bg-light);
      padding: 12px;
      border-radius: 8px;
    }

    .info-label {
      font-size: 11px;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .info-value {
      font-size: 14px;
      color: var(--text-dark);
      font-weight: 600;
      word-break: break-word;
    }

    /* ============= PROMO CODE ============= */
    .promo-section {
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .promo-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 12px;
    }

    .promo-input-group {
      display: flex;
      gap: 8px;
    }

    .promo-input {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: all 0.3s ease;
    }

    .promo-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
    }

    .promo-btn {
      background: var(--secondary);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      transition: all 0.3s ease;
    }

    .promo-btn:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    /* ============= ACTIONS ============= */
    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .btn {
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-checkout {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      grid-column: 1 / -1;
    }

    .btn-checkout:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
    }

    .btn-checkout:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-continue {
      background: var(--secondary);
      color: white;
    }

    .btn-continue:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
    }

    .btn-clear {
      background: var(--border-color);
      color: var(--text-dark);
    }

    .btn-clear:hover {
      background: #d5dbdb;
    }

    /* ============= SUCCESS ANIMATION ============= */
    .order-success {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
      padding: 30px 40px;
      border-radius: 16px;
      font-size: 24px;
      font-weight: 800;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 9999;
      display: none;
      max-width: 90%;
    }

    .order-success.animate {
      display: block;
      animation: popFade 2.5s ease forwards;
    }

    @keyframes popFade {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.5);
      }
      30% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.1);
      }
      60% {
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
    }

    /* ============= FOOTER ============= */
    footer {
      text-align: center;
      padding: 20px;
      font-size: 12px;
      color: var(--text-light);
      background: #fff;
      border-top: 1px solid var(--border-color);
    }

    /* ============= RESPONSIVE ============= */
    @media (max-width: 768px) {
      .cart-item {
        flex-wrap: wrap;
      }

      .item-price-section {
        width: 100%;
        justify-content: space-between;
      }

      .actions {
        grid-template-columns: 1fr;
      }

      .delivery-info {
        grid-template-columns: 1fr;
      }

      .promo-input-group {
        flex-direction: column;
      }

      .promo-btn {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      body {
        padding-bottom: 80px;
      }

      nav {
        padding: 12px 15px;
      }

      .brand-tagline {
        font-size: 16px;
      }

      .cart-section {
        padding: 15px 10px;
      }

      .section-header h2 {
        font-size: 22px;
      }

      .cart-item {
        padding: 12px;
        flex-direction: column;
        align-items: flex-start;
      }

      .item-emoji {
        font-size: 24px;
      }

      .item-name {
        font-size: 14px;
      }

      .item-price-section {
        width: 100%;
        justify-content: space-between;
        align-items: center;
      }

      .item-price {
        font-size: 15px;
      }

      .item-remove {
        font-size: 12px;
        padding: 6px 10px;
      }

      .cart-summary,
      .delivery-section,
      .promo-section {
        padding: 18px;
      }

      .summary-row,
      .summary-total-row {
        font-size: 13px;
      }

      .summary-total-row {
        font-size: 16px;
      }

      .btn {
        padding: 12px;
        font-size: 13px;
      }

      .empty-icon {
        font-size: 48px;
      }

      .empty-cart h3 {
        font-size: 18px;
      }

      .order-success {
        padding: 20px 25px;
        font-size: 18px;
      }
    }

    /* ============= LOADING ============= */
    .loading {
      text-align: center;
      padding: 40px 20px;
      font-size: 16px;
      color: var(--text-light);
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(46, 204, 113, 0.2);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav>
    <button class="back-btn" onclick="goBack()">‚Üê ‡§µ‡§æ‡§™‡§∏</button>
    <div class="brand-tagline">üõí ‡§Ü‡§™‡§ï‡§æ ‡§ï‡§æ‡§∞‡•ç‡§ü</div>
    <div class="cart-badge" id="cartCount">0</div>
  </nav>

  <!-- Popup -->
  <div id="popup" class="popup"></div>

  <!-- Success Animation -->
  <div id="orderSuccess" class="order-success">üéâ ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§∏‡§´‡§≤!</div>

  <!-- Main Section -->
  <div class="cart-section">
    <div class="section-header">
      <h2>üõí ‡§Ü‡§™‡§ï‡§æ ‡§ï‡§æ‡§∞‡•ç‡§ü</h2>
      <p class="section-subtitle">‡§∏‡§≠‡•Ä ‡§Ü‡§á‡§ü‡§Æ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç</p>
    </div>

    <!-- Cart Items -->
    <div id="cartContainer" class="cart-items"></div>

    <!-- Summary -->
    <div id="summaryBox" style="display: none;">
      <div class="cart-summary">
        <div class="summary-title">üßæ ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§∏‡§Æ‡§∞‡•Ä</div>
        <div class="summary-row">
          <span class="summary-label">‡§∏‡§¨‡•ç‡§ü‡•ã‡§ü‡§≤</span>
          <span class="summary-value" id="subtotal">‚Çπ0</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§ö‡§æ‡§∞‡•ç‡§ú</span>
          <span class="summary-value" id="delivery">FREE</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">‡§°‡§ø‡§∏‡•ç‡§ï‡§æ‡§â‡§Ç‡§ü</span>
          <span class="summary-value" id="discount" style="color: var(--primary);">- ‚Çπ0</span>
        </div>
        <div class="summary-total-row">
          <span>‡§ï‡•Å‡§≤ ‡§∞‡§æ‡§∂‡§ø</span>
          <span id="cartTotal">‚Çπ0</span>
        </div>
      </div>

      <!-- Delivery Info -->
      <div class="delivery-section">
        <div class="delivery-title">üìç ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</div>
        <div class="delivery-info">
          <div class="info-item">
            <div class="info-label">üë§ ‡§®‡§æ‡§Æ</div>
            <div class="info-value" id="delivery-name">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">üì± ‡§´‡•ã‡§®</div>
            <div class="info-value" id="delivery-phone">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">üìç ‡§™‡§ø‡§®‡§ï‡•ã‡§°</div>
            <div class="info-value" id="delivery-pincode">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">üèòÔ∏è ‡§á‡§≤‡§æ‡§ï‡§æ</div>
            <div class="info-value" id="delivery-area">-</div>
          </div>
        </div>
      </div>

      <!-- Promo Code -->
      <div class="promo-section">
        <div class="promo-title">üéüÔ∏è ‡§™‡•ç‡§∞‡§Æ‡•ã‡§∂‡§® ‡§ï‡•ã‡§°</div>
        <div class="promo-input-group">
          <input type="text" class="promo-input" id="promoCode" placeholder="‡§ï‡•ã‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">
          <button class="promo-btn" onclick="applyPromo()">‡§≤‡§æ‡§ó‡•Ç ‡§ï‡§∞‡•á‡§Ç</button>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button class="btn btn-continue" onclick="goBack()">üõçÔ∏è ‡§î‡§∞ ‡§ñ‡§∞‡•Ä‡§¶‡•á‡§Ç</button>
        <button class="btn btn-clear" onclick="clearCart()">üóëÔ∏è ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button>
        <button class="btn btn-checkout" id="checkoutBtn" onclick="checkout()">‚úÖ ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    ¬© 2025 Chandan Yadav, Ratu Jharkhand. All rights reserved. | üì± 24/7 ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü
  </footer>

  <script>
    // ============= CONSTANTS =============
    const API_BASE_URL = 'https://my-web-xrr5.onrender.com';
    const REQUEST_TIMEOUT = 10000;

    // ============= STATE =============
    const user = JSON.parse(localStorage.getItem("userData"));
    const token = localStorage.getItem("token");
    let cart = [];
    let discountAmount = 0;

    // ============= VALIDATION =============
    if (!user || !user._id || !token) {
      alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç");
      window.location.href = "login.html";
    }

    // ============= UTILITY FUNCTIONS =============
    function showPopup(message, isError = false) {
      const popup = document.getElementById("popup");
      popup.textContent = message;
      popup.className = isError ? "popup show error" : "popup show";
      setTimeout(() => popup.classList.remove("show"), 3000);
      console.log(isError ? "‚ùå" : "‚úÖ", message);
    }

    function el(id) {
      return document.getElementById(id);
    }

    function goBack() {
      window.history.back();
    }

    // ============= FETCH CART =============
    async function fetchCartFromServer() {
      try {
        console.log("üîÑ Fetching cart for user:", user._id);

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

        const res = await fetch(`${API_BASE_URL}/cart/${user._id}`, {
          headers: { "Authorization": `Bearer ${token}` },
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        const data = await res.json();

        if (data && data.items) {
          cart = data.items.map(item => ({
            productId: item.productId,
            name: item.name,
            qty: item.quantity,
            price: item.price,
            total: item.quantity * item.price
          }));
          console.log("‚úÖ Cart fetched:", cart.length, "items");
          renderCart();
        } else {
          cart = [];
          renderCart();
        }
      } catch (err) {
        console.error("‚ùå Cart fetch error:", err);
        showPopup("‚ùå ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ", true);
      }
    }

    // ============= RENDER CART =============
    function renderCart() {
      const container = el("cartContainer");
      const summaryBox = el("summaryBox");
      const countBadge = el("cartCount");

      if (cart.length === 0) {
        container.innerHTML = `
          <div class="empty-cart">
            <div class="empty-icon">üõí</div>
            <h3>‡§Ü‡§™‡§ï‡§æ ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à</h3>
            <p>‡§ï‡•Å‡§õ ‡§§‡§æ‡§ú‡§º‡•Ä ‡§∏‡§¨‡•ç‡§ú‡§ø‡§Ø‡§æ‡§Å ‡§ú‡•ã‡§°‡§º‡•á‡§Ç ‡§î‡§∞ ‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§ ‡§ï‡§∞‡•á‡§Ç</p>
            <button onclick="window.location.href='profiles.html'">‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞‡•Ä ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç</button>
          </div>
        `;
        summaryBox.style.display = "none";
        countBadge.textContent = "0";
        return;
      }

      // Render items
      container.innerHTML = cart.map((item, index) => {
        const qtyLabel = item.qty < 1 ? `${Math.round(item.qty * 1000)}‡§ó‡•ç‡§∞‡§æ‡§Æ` : `${item.qty} ‡§ï‡§ø‡§≤‡•ã`;
        const emojis = {
          '‡§Ü‡§≤‡•Ç': 'ü•î', '‡§ü‡§Æ‡§æ‡§ü‡§∞': 'üçÖ', '‡§™‡•ç‡§Ø‡§æ‡§ú‡§º': 'üßÖ', '‡§≠‡§ø‡§Ç‡§°‡•Ä': 'üå±',
          '‡§≤‡•å‡§ï‡•Ä': 'ü•í', '‡§ó‡§æ‡§ú‡§∞': 'ü•ï', '‡§Æ‡•Ç‡§≤‡•Ä': 'üåø', '‡§¨‡•à‡§Ç‡§ó‡§®': 'üçÜ',
          '‡§∂‡§ø‡§Æ‡§≤‡§æ ‡§Æ‡§ø‡§∞‡•ç‡§ö': 'ü´ë', '‡§π‡§∞‡•Ä ‡§Æ‡§ø‡§∞‡•ç‡§ö': 'üå∂Ô∏è', '‡§™‡§æ‡§≤‡§ï': 'ü•¨',
          '‡§≤‡§π‡§∏‡•Å‡§®': 'üßÑ', '‡§®‡•Ä‡§Ç‡§¨‡•Ç': 'üçã', '‡§Æ‡•á‡§•‡•Ä': 'üåø'
        };
        const emoji = emojis[item.name] || 'ü•¶';

        return `
          <div class="cart-item">
            <span class="item-emoji">${emoji}</span>
            <div class="item-info">
              <div class="item-name">${item.name}</div>
              <div class="item-qty">${qtyLabel}</div>
            </div>
            <div class="item-price-section">
              <div class="item-price">‚Çπ${item.total}</div>
              <button class="item-remove" onclick="removeItem(${index})">‡§π‡§ü‡§æ‡§è‡§Ç</button>
            </div>
          </div>
        `;
      }).join('');

      // Update summary
      const total = cart.reduce((sum, item) => sum + item.total, 0);
      const finalTotal = Math.max(0, total - discountAmount);

      el("subtotal").textContent = `‚Çπ${total}`;
      el("discount").textContent = discountAmount > 0 ? `- ‚Çπ${discountAmount}` : `- ‚Çπ0`;
      el("cartTotal").textContent = `‚Çπ${finalTotal}`;
      el("delivery-name").textContent = user.name;
      el("delivery-phone").textContent = user.phone;
      el("delivery-pincode").textContent = user.pincode;
      el("delivery-area").textContent = user.area;

      countBadge.textContent = cart.length;
      summaryBox.style.display = "block";

      el("checkoutBtn").disabled = total < 50;

      console.log("‚úÖ Cart rendered");
    }

    // ============= REMOVE ITEM =============
    async function removeItem(index) {
      try {
        const item = cart[index];
        showPopup("üîÑ ‡§π‡§ü‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...");

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

        const res = await fetch(`${API_BASE_URL}/cart/remove/${user._id}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ productId: item.name }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        const data = await res.json();

        if (res.ok) {
          cart.splice(index, 1);
          renderCart();
          showPopup("‚úÖ ‡§Ü‡§á‡§ü‡§Æ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ");
        }
      } catch (err) {
        console.error("‚ùå Remove error:", err);
        showPopup("‚ùå ‡§π‡§ü‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ", true);
      }
    }

    // ============= CLEAR CART =============
    async function clearCart() {
      if (!confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§™‡•Ç‡§∞‡§æ ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;

      try {
        showPopup("üîÑ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...");

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

        const res = await fetch(`${API_BASE_URL}/cart/clear/${user._id}`, {
          method: "POST",
          headers: { "Authorization": `Bearer ${token}` },
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (res.ok) {
          cart = [];
          discountAmount = 0;
          renderCart();
          showPopup("‚úÖ ‡§ï‡§æ‡§∞‡•ç‡§ü ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ");
        }
      } catch (err) {
        console.error("‚ùå Clear error:", err);
        showPopup("‚ùå ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ", true);
      }
    }

    // ============= APPLY PROMO =============
    function applyPromo() {
      const code = el("promoCode").value.trim().toUpperCase();

      const promoCodes = {
        'SAVE10': 0.10,
        'SAVE20': 0.20,
        'WELCOME50': 50,
        'FRESH100': 100
      };

      if (!code) {
        showPopup("‚ùå ‡§ï‡•ã‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç", true);
        return;
      }

      if (promoCodes[code]) {
        const total = cart.reduce((sum, item) => sum + item.total, 0);
        const discount = typeof promoCodes[code] === 'number' 
          ? (promoCodes[code] > 1 ? promoCodes[code] : Math.floor(total * promoCodes[code]))
          : 0;

        discountAmount = discount;
        renderCart();
        showPopup(`‚úÖ ${code} - ‚Çπ${discount} ‡§õ‡•Ç‡§ü ‡§≤‡§æ‡§ó‡•Ç!`);
        el("promoCode").value = "";
      } else {
        showPopup("‚ùå ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ï‡•ã‡§°", true);
      }
    }

    // ============= CHECKOUT =============
    async function checkout() {
      try {
        const totalAmount = cart.reduce((sum, item) => sum + item.total, 0);

        if (totalAmount < 50) {
          showPopup("‚ùå ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‚Çπ50 ‡§ï‡•Ä ‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞‡•Ä ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à", true);
          return;
        }

        const orderData = {
          products: cart.map(item => ({ 
            name: item.name, 
            qty: item.qty,
            price: item.price
          })),
          totalPrice: Math.max(0, totalAmount - discountAmount),
          customerName: user.name,
          address: `${user.address}, ${user.area}, ${user.pincode}`,
          phone: user.phone
        };

        console.log("üîÑ Placing order...", orderData);

        el("checkoutBtn").disabled = true;

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

        const res = await fetch(`${API_BASE_URL}/place-order`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify(orderData),
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        const data = await res.json();

        if (res.ok) {
          console.log("‚úÖ Order successful");
          showPopup("‚úÖ ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!");

          const successBox = el("orderSuccess");
          successBox.classList.add("animate");

          setTimeout(() => {
            successBox.classList.remove("animate");
            cart = [];
            discountAmount = 0;
            renderCart();
            window.location.href = "order.html";
          }, 2500);
        } else {
          throw new Error(data.error || "Order failed");
        }
      } catch (err) {
        console.error("‚ùå Checkout error:", err);
        showPopup("‚ùå ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ", true);
        el("checkoutBtn").disabled = false;
      }
    }

    // ============= PAGE LOAD =============
    window.addEventListener('DOMContentLoaded', () => {
      console.log("‚úÖ Cart page loaded");
      fetchCartFromServer();
    });

    // ============= ERROR HANDLING =============
    window.addEventListener('error', (event) => {
      console.error('‚ùå Global error:', event.error);
    });
  </script>
</body>
</html>
