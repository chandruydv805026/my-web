<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ratu Fresh - Premium Shop</title>
  <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2e7d32">
<link rel="apple-touch-icon" href="icons/icon-192.png">
  
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  
  <style>
    :root { --primary: #2e7d32; --bg: #f4f7f6; --white: #ffffff; --shadow: 0 4px 20px rgba(0,0,0,0.08); }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }
    body { background: var(--bg); color: #333; padding-bottom: 100px; overflow-x: hidden; }
    .header { background: linear-gradient(135deg, #1b5e20, #2e7d32); color: white; padding: 20px 15px; position: sticky; top: 0; z-index: 1000; border-radius: 0 0 25px 25px; }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .brand { font-size: 1.5rem; font-weight: 800; letter-spacing: -1px; }
    .search-bar { width: 100%; padding: 14px; border: none; border-radius: 15px; outline: none; box-shadow: var(--shadow); font-size: 15px; }
    .slider-container { width: 100%; overflow: hidden; margin: 15px 0; border-radius: 20px; height: 130px; position: relative; box-shadow: var(--shadow); }
    .slider { display: flex; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); height: 100%; }
    .slide { min-width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 20px; }
    .slide1 { background: linear-gradient(45deg, #ff512f, #dd2476); }
    .slide2 { background: linear-gradient(45deg, #00b4db, #0083b0); }
    .slide3 { background: linear-gradient(45deg, #1d976c, #93f9b9); color: #1b5e20; }
    .slide h2 { font-size: 1.4rem; font-weight: 800; }
    .banner-img { width: 100%; height: 100%; object-fit: cover; border-radius: 20px; }
    .view-section { display: none; padding: 15px; animation: fadeIn 0.4s ease; }
    .active-view { display: block !important; }
    #product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .card { background: var(--white); border-radius: 20px; overflow: hidden; box-shadow: var(--shadow); margin-bottom: 0px; border: 1px solid rgba(0,0,0,0.02); display: flex; flex-direction: column; }
    .card-img { width: 100%; height: 130px; object-fit: cover; }
    .card-body { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .card-body h3 { font-size: 14px; font-weight: 800; }
    .price-row { display: flex; flex-direction: column; align-items: flex-start; margin: 8px 0; gap: 4px; }
    .price-row h3 { font-size: 16px; color: var(--primary); font-weight: 900; }
    .qty-select-style { width: 100%; border: 1px solid #edf2f7; border-radius: 8px; padding: 6px; font-size: 11px; font-weight: 700; background: #f8fafc; color: #444; outline: none; }
    .add-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 13px; cursor: pointer; transition: 0.2s; }
    .add-btn:active { transform: scale(0.95); }
    .cart-item-modern { background: white; border-radius: 20px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: var(--shadow); border: 1px solid #f0f0f0; }
    .cart-img-small { width: 65px; height: 65px; border-radius: 12px; object-fit: cover; }
    .cart-item-details { flex: 1; margin-left: 15px; }
    .cart-item-details h4 { font-size: 15px; font-weight: 700; }
    .cart-item-details p { font-size: 12px; color: #888; margin-top: 2px; }
    .cart-price-tag { font-weight: 800; color: var(--primary); font-size: 16px; margin-top: 4px; }
    .delete-btn-text { background: #fff5f5; color: #ff4444; border: none; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: 800; }
    .cancel-btn { background: #fff5f5; color: #ff4444; border: 1px solid #ffebeb; padding: 10px; border-radius: 12px; cursor: pointer; font-size: 12px; font-weight: 800; width: 100%; margin-top: 10px; }
    .avatar-circle { width: 85px; height: 85px; background: var(--primary); color: white; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: 800; border: 4px solid #fff; box-shadow: var(--shadow); }
    .profile-card { background: white; padding: 25px; border-radius: 30px; box-shadow: var(--shadow); }
    .input-group { margin-bottom: 15px; text-align: left; }
    .input-group label { font-size: 10px; font-weight: 800; color: #aaa; margin-left: 5px; }
    .profile-input { width: 100%; padding: 12px; border-radius: 12px; border: 1.5px solid #f0f0f0; outline: none; margin-top: 5px; font-weight: 600; background: #fafafa; }
    .detect-btn { background: #e8f5e9; color: var(--primary); border: 1.5px solid var(--primary); padding: 8px 15px; border-radius: 12px; font-size: 12px; font-weight: 800; cursor: pointer; margin-bottom: 15px; display: block; width: 100%; }
    .bill-card { background: white; border-radius: 25px; padding: 20px; margin-top: 20px; box-shadow: var(--shadow); border: 1px dashed #ddd; }
    .bill-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; font-weight: 600; color: #666; }
    .bill-total { border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; color: #000; font-size: 18px; font-weight: 800; }
    .min-order-msg { color: #f44336; font-size: 11px; font-weight: 800; text-align: center; margin-bottom: 10px; display: none; }
    #custom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 25px; }
    .modal-box { background: white; padding: 30px; border-radius: 25px; width: 100%; max-width: 340px; text-align: center; animation: pop 0.3s ease; }
    #success-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 6000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #eee; z-index: 2000; }
    .nav-icon { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #bbb; border: none; background: none; outline: none; cursor: pointer; position: relative; }
    .nav-icon.active { color: var(--primary); }
    .nav-icon img { width: 24px; height: 24px; opacity: 0.4; }
    .nav-icon.active img { opacity: 1; }
    .cart-badge { background: #ff3b30; color: white; min-width: 16px; height: 16px; padding: 0 4px; border-radius: 10px; font-size: 9px; font-weight: 800; position: absolute; top: -2px; right: -4px; display: none; align-items: center; justify-content: center; border: 1.5px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .order-items-summary { margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0; width: 100%; }
    .order-item-row { display: flex; justify-content: space-between; font-size: 12px; color: #555; margin-bottom: 4px; font-weight: 600; }
    @media (min-width: 768px) { #product-grid { grid-template-columns: repeat(3, 1fr); gap: 20px; } .card-img { height: 200px; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
    @keyframes pop { from { transform: scale(0.8); } to { transform: scale(1); } }
  </style>
</head>
<body>

  <div id="custom-modal"><div class="modal-box" id="modal-content"></div></div>

  <div id="success-overlay">
    <div style="font-size: 80px; margin-bottom: 20px;">üéâ</div>
    <h1 style="color: var(--primary);">Order Placed!</h1>
    <p style="color: #666; font-weight: 600;">Ratu Fresh is bringing healthy vegetables to your doorstep!</p>
    <div style="font-size: 40px; margin-top: 20px;">üööüí®</div>
  </div>

  <header class="header" id="app-header">
    <div class="header-top">
      <div class="brand">Ratu Fresh</div>
      <div id="user-welcome" style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-weight: 600;">Hi!</div>
    </div>
    <input type="text" class="search-bar" id="search" placeholder="Search vegetables..." onkeyup="render()">
  </header>

  <div id="shop-view" class="view-section active-view">
    <div class="slider-container">
      <div class="slider" id="offerSlider">
        <div class="slide slide1"><h2>10% DISCOUNT</h2><p>Limited time offer!</p></div>
        <div class="slide slide2"><h2>FREE DELIVERY</h2><p>Above ‚Çπ50</p></div>
        <div class="slide slide3"><h2>100% HEALTHY</h2><p>Organic for you</p></div>
      </div>
    </div>
    <main id="product-grid"></main>
  </div>

  <div id="cart-view" class="view-section">
    <h2 style="margin-bottom: 20px;">Review Items üõí</h2>
    <div id="cart-items-list"></div>
    <div id="cart-empty" style="text-align: center; margin-top: 80px; color: #bbb; display:none;"><p>Your cart is empty!</p></div>
    <div id="cart-summary-section" style="display:none;">
        <div class="bill-card">
            <h4 style="margin-bottom:15px;">Price Details</h4>
            <div class="bill-row"><span>Items Total</span><span id="bill-items-total">‚Çπ0</span></div>
            <div class="bill-row"><span>Delivery</span><span style="color:var(--primary); font-weight: 800;">FREE</span></div>
            <div class="bill-row bill-total"><span>Total Payable</span><span id="bill-grand-total">‚Çπ0</span></div>
        </div>
        <div style="margin-top: 20px; background: white; padding: 15px; border-radius: 20px; box-shadow: var(--shadow);">
          <p id="min-order-warning" class="min-order-msg">‚ö†Ô∏è Min. order value is ‚Çπ50 to place order</p>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div><p style="font-size: 11px; color: #aaa; font-weight: 700;">TOTAL AMOUNT</p><h2 id="total-amount" style="color: var(--primary);">‚Çπ0</h2></div>
            <button id="place-order-btn" class="add-btn" style="width: auto; padding: 14px 35px;" onclick="confirmOrderModal()">Place Order</button>
          </div>
        </div>
    </div>
  </div>

  <div id="orders-view" class="view-section">
    <h2>My Orders üì¶</h2>
    <p style="font-size: 11px; color: #888; margin-bottom: 20px; font-weight: 600;">
        Note: Your order history will be automatically deleted from the server after 2 hours.
    </p>
    <div id="order-history-list"></div>
  </div>

  <div id="profile-view" class="view-section"></div>

  <nav class="bottom-nav">
    <button class="nav-icon active" onclick="switchView('shop', this)"><img src="https://cdn-icons-png.flaticon.com/512/1946/1946436.png"><label style="font-size: 10px; font-weight: 700;">Home</label></button>
    <button class="nav-icon" onclick="switchView('cart', this)">
        <img src="https://cdn-icons-png.flaticon.com/512/1170/1170678.png">
        <label style="font-size: 10px; font-weight: 700;">Cart</label>
        <span id="cart-count" class="cart-badge">0</span>
    </button>
    <button class="nav-icon" onclick="switchView('orders', this)"><img src="https://cdn-icons-png.flaticon.com/512/3500/3500833.png"><label style="font-size: 10px; font-weight: 700;">Orders</label></button>
    <button class="nav-icon" onclick="switchView('profile', this)"><img src="https://cdn-icons-png.flaticon.com/512/9131/9131529.png"><label style="font-size: 10px; font-weight: 700;">Profile</label></button>
  </nav>

<script>
    const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                    ? 'http://localhost:4000' 
                    : 'https://my-web-xrr5.onrender.com';

    let currentView = 'shop';
    let currentCartTotal = 0;
    let tempCoords = { lat: null, lng: null };
    let products = []; 
    let banners = []; 
    let totalBanners = 3; 
    let currentSlide = 0;

    // --- [IMPORTANT] Fixed Load Logic ---
    window.onload = async () => { 
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        if (urlToken) { localStorage.setItem('token', urlToken); }
        
        const token = localStorage.getItem('token');
        if(token && token !== "null" && token !== "undefined") { 
            try {
                const res = await fetch(`${API_URL}/api/user-profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if(data.success) {
                    localStorage.setItem('user', JSON.stringify(data.user));
                    updateHeaderName();
                    loadProfile();
                    await syncEverything();
                    setInterval(syncEverything, 5000); // ‡§¶‡§æ‡§Æ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§ø‡§Ç‡§ï ‡§ö‡§æ‡§≤‡•Ç ‡§∞‡§ñ‡•á‡§Ç
                    initialCartLoad();
                    if (urlParams.get('verified') === 'true') {
                        showAlert('Verified! ‚úÖ', 'Welcome to Ratu Fresh.', 'success');
                    }
                } else {
                    window.location.href = 'main.html';
                }
            } catch(e) { window.location.href = 'main.html'; }
        } else window.location.href = 'main.html'; 
    };

    window.history.replaceState({ view: 'shop' }, 'shop', "");

    window.addEventListener('popstate', function(event) {
        const modal = document.getElementById('custom-modal');
        if (modal && modal.style.display === 'flex') {
            closeModal();
            window.history.pushState({ view: currentView }, currentView, ""); 
            return;
        }

        if (currentView !== 'shop') {
            const homeBtn = document.querySelectorAll('.nav-icon')[0];
            changeViewOnlyUI('shop', homeBtn);
        }
    });

    async function changeViewOnlyUI(viewId, btn) {
        currentView = viewId;
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active-view'));
        const target = document.getElementById(viewId + '-view');
        if(target) target.classList.add('active-view');
        
        document.querySelectorAll('.nav-icon').forEach(n => n.classList.remove('active'));
        if(btn) btn.classList.add('active');
        
        const header = document.getElementById('app-header');
        if(header) header.style.display = (viewId === 'shop') ? 'block' : 'none';
        
        if(viewId === 'shop') {
            await syncEverything(); // ‡§π‡•ã‡§Æ ‡§™‡§∞ ‡§Ü‡§§‡•á ‡§π‡•Ä ‡§§‡§æ‡§ú‡§æ ‡§¶‡§æ‡§Æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
        }
        if(viewId === 'cart') await fetchCartFromDB();
        if(viewId === 'orders') await fetchOrdersFromDB();
        if(viewId === 'profile') loadProfile();
        updateHeaderName();
    }

    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
        if (window.location.hostname !== 'ratufresh.me' && window.location.hostname !== 'localhost') return;

        await OneSignal.init({
            appId: "bcfc9f9f-7c9c-43e6-9b75-8d10bdb1a06b",
            allowLocalhostAsSecureOrigin: false,
            notifyButton: { enable: true },
        });

        const user = JSON.parse(localStorage.getItem('user'));
        if (user && user.phone) { 
            await OneSignal.login(user.phone); 
        }
    });

    async function syncEverything() {
        try {
            const pRes = await fetch(`${API_URL}/api/products?t=${Date.now()}`);
            const newProducts = await pRes.json();
            // [FIX] ‡§Ø‡§π‡§æ‡§Å JSON.stringify ‡§π‡§ü‡§æ‡§ï‡§∞ ‡§∏‡•Ä‡§ß‡•á ‡§ö‡•á‡§ï ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§¶‡§æ‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§∞‡•Ä-‡§∞‡•á‡§Ç‡§°‡§∞ ‡§π‡•ã
            if (JSON.stringify(products) !== JSON.stringify(newProducts)) {
                products = newProducts;
                render(); 
            }

            const bRes = await fetch(`${API_URL}/api/banners?t=${Date.now()}`);
            const newBanners = await bRes.json();
            if (JSON.stringify(banners) !== JSON.stringify(newBanners)) {
                banners = newBanners;
                updateBannersUI();
            }
        } catch (e) { console.log("Sync Error"); }
    }

    function updateBannersUI() {
        const slider = document.getElementById('offerSlider');
        if(!slider) return;
        let bannersHTML = `
            <div class="slide slide1"><h2>10% DISCOUNT</h2><p>Limited time offer!</p></div>
            <div class="slide slide2"><h2>FREE DELIVERY</h2><p>Above ‚Çπ50</p></div>
            <div class="slide slide3"><h2>100% HEALTHY</h2><p>Organic for you</p></div>
        `;
        banners.forEach(b => {
            bannersHTML += `
                <div class="slide">
                    <img src="${API_URL}${b.img}" class="banner-img" alt="Offer">
                </div>`;
        });
        slider.innerHTML = bannersHTML;
        totalBanners = 3 + banners.length;
    }

    function updateHeaderName() {
        const user = JSON.parse(localStorage.getItem('user'));
        if(user) document.getElementById('user-welcome').innerText = "Hi, " + user.name.split(' ')[0] + "!";
    }

    function updatePriceUI(id, basePrice) {
        const q = parseFloat(document.getElementById('qty-'+id).value);
        document.getElementById('price-label-'+id).innerText = "‚Çπ" + (basePrice * q).toFixed(0);
    }

    function render() {
        const searchTerm = document.getElementById("search").value.toLowerCase();
        const grid = document.getElementById('product-grid');
        if (!grid || currentView !== 'shop') return; 
        const filtered = products.filter(p => p.name.toLowerCase().includes(searchTerm));
        grid.innerHTML = filtered.map(p => {
            let opts = p.unit === 'pc' 
                ? `<option value="1">1 Piece</option><option value="5">5 Pieces</option><option value="10">10 Pieces</option>`
                : `<option value="0.25">250 g</option><option value="0.5">500 g</option><option value="1" selected>1 kg</option><option value="2">2 kg</option><option value="3">3 kg</option><option value="5">5 kg</option>`;

            const imgSrc = p.img.startsWith('http') ? p.img : API_URL + p.img;

            return `<div class="card">
                <img src="${imgSrc}" class="card-img" onerror="this.src='https://via.placeholder.com/200x150?text=Fresh'">
                <div class="card-body">
                    <h3>${p.name}</h3>
                    <div class="price-row">
                        <h3 id="price-label-${p.id}">‚Çπ${p.price}</h3>
                        <select id="qty-${p.id}" class="qty-select-style" onchange="updatePriceUI('${p.id}', ${p.price})">${opts}</select>
                    </div>
                    <button class="add-btn" onclick="addToCart('${p.id}')">Add to Cart</button>
                </div>
            </div>`;
        }).join('');
    }

    async function addToCart(id) {
        const token = localStorage.getItem('token');
        const p = products.find(i => i.id === id); 
        const q = parseFloat(document.getElementById('qty-'+id).value);
        const currentPrice = p.price; 
        const totalP = currentPrice * q;
        const unitLabel = p.unit === 'pc' ? (q > 1 ? 'pcs' : 'pc') : 'kg';

        try {
            const res = await fetch(`${API_URL}/cart/sync`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ item: { productId: p.id, name: p.name, quantity: q, price: currentPrice, subtotal: totalP, unit: p.unit } })
            });
            if(res.ok) {
                const data = await res.json();
                showAlert('Success!', `Added ${q} ${unitLabel} ${p.name} to cart. <br><b>Total: ‚Çπ${totalP.toFixed(0)}</b>`, 'success');
                updateCartBadge(data.cart.items.length);
            }
        } catch (err) { }
    }

    function updateCartBadge(count) {
        const badge = document.getElementById('cart-count');
        if(!badge) return;
        if(count > 0) {
            badge.innerText = count;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }

    async function fetchCartFromDB() {
        const token = localStorage.getItem('token');
        const list = document.getElementById('cart-items-list');
        const summary = document.getElementById('cart-summary-section');
        const empty = document.getElementById('cart-empty');
        const warning = document.getElementById('min-order-warning');
        const placeBtn = document.getElementById('place-order-btn');
        
        try {
            const res = await fetch(`${API_URL}/cart/get`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            
            if(!data.items || data.items.length === 0) {
                if(list) list.innerHTML = ""; if(summary) summary.style.display = "none"; if(empty) empty.style.display = "block"; 
                updateCartBadge(0);
                return;
            }

            if(empty) empty.style.display = "none"; if(summary) summary.style.display = "block";
            currentCartTotal = data.totalPrice;
            if(warning) warning.style.display = currentCartTotal < 50 ? 'block' : 'none';
            if(placeBtn) {
              placeBtn.disabled = currentCartTotal < 50;
              placeBtn.style.opacity = currentCartTotal < 50 ? '0.5' : '1';
            }

            if(list) {
              list.innerHTML = data.items.map(item => {
                  const product = products.find(p => p.id === item.productId);
                  const finalImg = product ? (product.img.startsWith('http') ? product.img : API_URL + product.img) : '';
                  return `
                  <div class="cart-item-modern">
                      <img src="${finalImg}" class="cart-img-small">
                      <div class="cart-item-details">
                          <h4>${item.name}</h4>
                          <p>${item.quantity}${item.unit === 'pc' ? ' pcs' : 'kg'} ‚Ä¢ ‚Çπ${item.price}/${item.unit === 'pc' ? 'pc' : 'kg'}</p>
                          <div class="cart-price-tag">‚Çπ${item.subtotal}</div>
                      </div>
                      <button class="delete-btn-text" onclick="removeFromCart('${item.productId}')">Delete</button>
                  </div>`;
              }).join('');
            }
            
            if(document.getElementById('bill-items-total')) document.getElementById('bill-items-total').innerText = "‚Çπ" + data.totalPrice;
            if(document.getElementById('bill-grand-total')) document.getElementById('bill-grand-total').innerText = "‚Çπ" + data.totalPrice;
            if(document.getElementById('total-amount')) document.getElementById('total-amount').innerText = "‚Çπ" + data.totalPrice;
            updateCartBadge(data.items.length);
        } catch (err) { }
    }

    async function removeFromCart(productId) {
        const token = localStorage.getItem('token');
        await fetch(`${API_URL}/cart/remove/${productId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
        await fetchCartFromDB();
    }

    function confirmOrderModal() {
        if(currentCartTotal < 50) return showAlert('Wait!', 'Minimum order is ‚Çπ50', 'error');
        showAlert('Place Order?', 'Confirm to place your order.', 'confirm', processOrder);
    }

    async function processOrder() {
        const token = localStorage.getItem('token');
        const btn = document.getElementById('place-order-btn');
        const originalText = btn ? btn.innerText : 'Place Order';
        
        try {
            if(btn) {
              btn.disabled = true;
              btn.style.opacity = '0.7';
              btn.innerText = 'Processing... ‚è≥';
            }
            const user = JSON.parse(localStorage.getItem('user'));
            const res = await fetch(`${API_URL}/orders/place`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ address: user.address + ", " + user.area })
            });
            if(res.ok) {
                updateCartBadge(0);
                document.getElementById('success-overlay').style.display = 'flex';
                setTimeout(() => { 
                    document.getElementById('success-overlay').style.display = 'none'; 
                    const orderBtn = document.querySelectorAll('.nav-icon')[2];
                    changeViewOnlyUI('orders', orderBtn); 
                    if(btn) {
                      btn.disabled = false;
                      btn.style.opacity = '1';
                      btn.innerText = originalText;
                    }
                }, 4000);
            } else { throw new Error("Order Failed"); }
        } catch (err) {
            if(btn) {
              btn.disabled = false;
              btn.style.opacity = '1';
              btn.innerText = originalText;
            }
            showAlert('Error', 'Order failed. Please login again.', 'error');
        }
    }

    async function fetchOrdersFromDB() {
        const token = localStorage.getItem('token');
        const list = document.getElementById('order-history-list');
        if(!list) return;
        try {
            const res = await fetch(`${API_URL}/orders/my-orders`, { headers: { 'Authorization': `Bearer ${token}` } });
            const orders = await res.json();
            if(!orders || orders.length === 0) {
                list.innerHTML = `<div style="text-align:center; margin-top:50px; color:#bbb;"><p>No orders yet!</p></div>`;
                return;
            }
            list.innerHTML = orders.map(o => {
                const itemsDetails = o.items.map(item => `
                    <div class="order-item-row">
                        <span>‚Ä¢ ${item.name}</span>
                        <span>${item.quantity}${item.unit === 'pc' ? 'pc' : 'kg'}</span>
                    </div>`).join('');
                return `
                <div class="cart-item-modern" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                    <div style="display: flex; width: 100%; align-items: center; justify-content: space-between;">
                        <div class="cart-item-details" style="margin-left: 0;">
                            <p style="font-size: 10px; color: #aaa; font-weight: 800;">ORDER ID: #${o._id.substring(0,8)}</p>
                            <h4 style="margin: 3px 0;">${o.items.length} Items Purchased</h4>
                            <span style="font-size:11px; background:${o.status === 'Cancelled' ? '#ffebee' : '#e8f5e9'}; color:${o.status === 'Cancelled' ? '#ff4444' : 'var(--primary)'}; padding:3px 10px; border-radius:10px; font-weight:700;">${o.status}</span>
                        </div>
                        <div class="cart-price-tag">‚Çπ${o.totalAmount}</div>
                    </div>
                    <div class="order-items-summary">${itemsDetails}</div>
                    ${o.status === 'Pending' ? `<button class="cancel-btn" onclick="cancelOrder('${o._id}')">CANCEL ORDER</button>` : ''}
                </div>`;
            }).join('');
        } catch (err) { }
    }

    function cancelOrder(orderId) {
        showAlert('Cancel?', 'Are you sure you want to cancel?', 'cancel-ask', async () => {
            const token = localStorage.getItem('token');
            await fetch(`${API_URL}/orders/cancel/${orderId}`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
            fetchOrdersFromDB();
        });
    }

    function detectMyLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    tempCoords.lat = lat;
                    tempCoords.lng = lng;
                    try {
                        const res = await fetch(`${API_URL}/reverse-geocode`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ lat, lng })
                        });
                        const data = await res.json();
                        if(res.ok) {
                            if(document.getElementById('upd-addr')) document.getElementById('upd-addr').value = data.displayName;
                            if(document.getElementById('upd-area')) document.getElementById('upd-area').value = data.area || data.pincode;
                            await updateProfileDB();
                        } else {
                            showAlert('Area Error', data.error, 'error');
                        }
                    } catch (err) {
                        showAlert('Error', 'Failed to get address details.', 'error');
                    }
                },
                (error) => { showAlert('Permission Denied', 'Please allow location access.', 'error'); },
                { enableHighAccuracy: true }
            );
        } else { showAlert('Not Supported', 'Location not supported.', 'error'); }
    }

    function loadProfile() {
        const user = JSON.parse(localStorage.getItem('user'));
        if(!user) return;
        const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0,2);
        const profileView = document.getElementById('profile-view');
        if(profileView) {
          profileView.innerHTML = `
              <div class="profile-card">
                  <div class="avatar-circle">${initials}</div>
                  <h3 style="text-align: center; margin-bottom: 25px;">Account Details</h3>
                  <button class="detect-btn" onclick="detectMyLocation()">üìç Detect & Save Location</button>
                  <div class="input-group"><label>NAME</label><input type="text" id="upd-name" class="profile-input" value="${user.name}"></div>
                  <div class="input-group"><label>PHONE</label><input type="tel" id="upd-phone" class="profile-input" value="${user.phone}"></div>
                  <div class="input-group"><label>ADDRESS</label><input type="text" id="upd-addr" class="profile-input" value="${user.address}"></div>
                  <div class="input-group"><label>AREA / PINCODE</label><input type="text" id="upd-area" class="profile-input" value="${user.area || ''}"></div>
                  <div class="input-group"><label>EMAIL (READ ONLY)</label><input type="text" class="profile-input" value="${user.email}" disabled style="color:#aaa;"></div>
                  <button class="add-btn" style="margin-top: 15px;" onclick="updateProfileDB()">Save Changes</button>
                  <button onclick="logout()" style="width: 100%; margin-top: 25px; background: none; border: none; color: #ff4444; font-weight: 800; font-size: 13px; cursor:pointer;">LOGOUT ACCOUNT</button>
              </div>`;
        }
    }

    async function updateProfileDB() {
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user'));
        const payload = { 
            name: document.getElementById('upd-name')?.value || user.name, 
            phone: document.getElementById('upd-phone')?.value || user.phone, 
            address: document.getElementById('upd-addr')?.value || user.address, 
            area: document.getElementById('upd-area')?.value || user.area,
            lat: tempCoords.lat || user.lat,
            lng: tempCoords.lng || user.lng
        };
        try {
            const res = await fetch(`${API_URL}/user/update`, { 
                method: 'PUT', 
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
                body: JSON.stringify(payload) 
            });
            if(res.ok) {
                const data = await res.json();
                localStorage.setItem('user', JSON.stringify(data.user));
                updateHeaderName();
                loadProfile();
                tempCoords = { lat: null, lng: null };
                showAlert('Profile Updated!', 'Your changes have been saved successfully.', 'success');
            }
        } catch (err) { showAlert('Error', 'Failed to save changes.', 'error'); }
    }

    function logout() { 
        showAlert('Logout?', 'Sign out from Ratu Fresh?', 'cancel-ask', () => { 
            localStorage.clear(); 
            window.location.href = 'main.html'; 
        }); 
    }

    function showAlert(title, msg, type = 'info', action = null) {
        const box = document.getElementById('modal-content');
        if(!box) return;
        
        box.innerHTML = `
            <div style="font-size: 50px; margin-bottom: 15px;">${type === 'confirm' ? 'üõí' : (type === 'error' ? '‚ùå' : (type === 'cancel-ask' ? '‚ö†Ô∏è' : '‚úÖ'))}</div>
            <h3 style="margin-bottom: 10px;">${title}</h3>
            <p style="color: #666; font-size: 14px;">${msg}</p>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                ${(type === 'confirm' || type === 'cancel-ask') ? `<button onclick="closeModal()" style="flex:1; padding:12px; background:#f5f5f5; border-radius:12px; border:none; font-weight:700;">No</button>` : ''}
                <button id="modal-ok" style="flex:1; padding:12px; background:var(--primary); color:white; border-radius:12px; border:none; font-weight:700;">Continue</button>
            </div>`;
        document.getElementById('custom-modal').style.display = 'flex';
        document.getElementById('modal-ok').onclick = () => { closeModal(); if(action) action(); };
    }
    
    function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }

    async function switchView(viewId, btn) {
        if(currentView === viewId) return;
        window.history.pushState({ view: viewId }, viewId, "");
        await changeViewOnlyUI(viewId, btn);
    }

    setInterval(() => {
        const slider = document.getElementById('offerSlider');
        if(slider) { 
            currentSlide = (currentSlide + 1) % totalBanners; 
            slider.style.transform = `translateX(-${currentSlide * 100}%)`; 
        }
    }, 4000);

    setInterval(() => {
        if(currentView === 'cart') {
            fetchCartFromDB();
        }
    }, 5000);

    async function initialCartLoad() {
        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`${API_URL}/cart/get`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            if(data.items) updateCartBadge(data.items.length);
        } catch(e) {}
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
          console.log('PWA Registered');
        }).catch(function(err) {
          console.log('PWA Registration failed: ', err);
        });
      });
    }
</script>
</body>
</html>
