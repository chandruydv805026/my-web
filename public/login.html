<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#2ecc71">
  <title>Ratu Fresh ‚Äì Login üîê</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2ecc71;
      --primary-dark: #27ae60;
      --secondary: #3498db;
      --tertiary: #e74c3c;
      --text-dark: #2c3e50;
      --text-light: #7f8c8d;
      --border-color: #ecf0f1;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    /* ============= POPUP ============= */
    .popup {
      position: fixed;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: #fff;
      padding: 16px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: var(--shadow);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      text-align: center;
      max-width: 90%;
    }

    .popup.show {
      bottom: 30px;
      opacity: 1;
    }

    .popup.error {
      background: var(--tertiary);
    }

    /* ============= CONTAINER ============= */
    .login-container {
      background: #fff;
      border-radius: 16px;
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 450px;
      padding: 40px;
      animation: slideUp 0.6s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ============= HEADER ============= */
    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .login-header h1 {
      font-size: 28px;
      color: var(--text-dark);
      font-weight: 800;
      margin-bottom: 8px;
    }

    .login-header p {
      font-size: 14px;
      color: var(--text-light);
    }

    /* ============= FORM ============= */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input {
      width: 100%;
      padding: 14px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.1);
    }

    input::placeholder {
      color: var(--text-light);
    }

    /* ============= BUTTONS ============= */
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }

    button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--secondary);
      color: #fff;
    }

    .btn-secondary:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
    }

    /* ============= HIDDEN ELEMENTS ============= */
    .hidden {
      display: none !important;
    }

    /* ============= LINKS ============= */
    .login-footer {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: var(--text-light);
    }

    .login-footer a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 700;
      transition: all 0.3s ease;
    }

    .login-footer a:hover {
      color: var(--primary-dark);
    }

    /* ============= OTP INPUT ============= */
    .otp-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .otp-input {
      width: 50px !important;
      height: 50px;
      text-align: center;
      font-size: 24px !important;
      font-weight: 800;
      padding: 10px !important;
    }

    .otp-input:nth-child(n+2) {
      margin-left: 2px;
    }

    /* ============= RESPONSIVE ============= */
    @media (max-width: 480px) {
      .login-container {
        padding: 25px;
      }

      .login-header h1 {
        font-size: 24px;
      }

      .logo {
        font-size: 40px;
      }

      button {
        padding: 12px;
        font-size: 13px;
      }

      .otp-input {
        width: 40px !important;
        height: 40px;
        font-size: 18px !important;
      }
    }

    /* ============= LOADING ============= */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <!-- Popup -->
  <div id="popup" class="popup"></div>

  <!-- Login Container -->
  <div class="login-container">
    <!-- Header -->
    <div class="login-header">
      <div class="logo">ü•¨</div>
      <h1>Ratu Fresh</h1>
      <p>‡§§‡§æ‡§ú‡§º‡•Ä ‡§∏‡§¨‡•ç‡§ú‡§ø‡§Ø‡§æ‡§Å, ‡§§‡•á‡§ú‡§º ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä</p>
    </div>

    <!-- Login Form -->
    <form id="loginForm">
      <!-- Phone Input -->
      <div id="phoneSection">
        <div class="form-group">
          <label for="phone">üì± ‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞</label>
          <input 
            type="tel" 
            id="phone" 
            placeholder="10-digit number ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç"
            maxlength="10"
            pattern="[0-9]{10}"
          />
        </div>

        <div class="button-group">
          <button type="button" class="btn-primary" onclick="sendOTP()">
            ‚úâÔ∏è OTP ‡§≠‡•á‡§ú‡•á‡§Ç
          </button>
          <button type="button" class="btn-secondary" onclick="goToSignup()">
            üìù Signup
          </button>
        </div>
      </div>

      <!-- OTP Section (Hidden) -->
      <div id="otpSection" class="hidden">
        <div class="form-group">
          <label>üîê OTP ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</label>
          <div class="otp-input-group" id="otpInputGroup">
            <input type="text" class="otp-input" maxlength="1" placeholder="0" />
            <input type="text" class="otp-input" maxlength="1" placeholder="0" />
            <input type="text" class="otp-input" maxlength="1" placeholder="0" />
            <input type="text" class="otp-input" maxlength="1" placeholder="0" />
            <input type="text" class="otp-input" maxlength="1" placeholder="0" />
            <input type="text" class="otp-input" maxlength="1" placeholder="0" />
          </div>

          <div class="form-group">
            <small style="color: var(--text-light);">
              OTP ‡§Ü‡§™‡§ï‡•á email ‡§™‡§∞ ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à
            </small>
          </div>
        </div>

        <div class="button-group">
          <button type="button" class="btn-primary" onclick="verifyOTP()">
            ‚úÖ Verify ‡§ï‡§∞‡•á‡§Ç
          </button>
          <button type="button" class="btn-secondary" onclick="resendOTP()">
            üîÑ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§≠‡•á‡§ú‡•á‡§Ç
          </button>
        </div>

        <button 
          type="button" 
          style="width: 100%; background: var(--border-color); color: var(--text-dark); margin-top: 10px;"
          onclick="goBackToPhone()"
        >
          ‚Üê ‡§µ‡§æ‡§™‡§∏
        </button>
      </div>
    </form>

    <!-- Footer -->
    <div class="login-footer">
      ‡§ñ‡§æ‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à? <a href="signup.html">Signup ‡§ï‡§∞‡•á‡§Ç</a>
    </div>
  </div>

  <script>
    // ============= CONSTANTS =============
    const API_BASE_URL = 'https://my-web-xrr5.onrender.com';
    const REQUEST_TIMEOUT = 10000;
    const VAPID_PUBLIC_KEY = 'BOK6YcWupVRim0Dimrf7u3sZcijkOzLv9nsRX8_DcXSZ1zrjMk3z18XWDEBuGMXG_e2fACCx1V8K_DHkqbEaYA8';

    // ============= STATE =============
    let currentPhone = '';
    let otpAttempts = 0;

    // ============= UTILITY FUNCTIONS =============
    function showPopup(message, type = 'success') {
      const popup = document.getElementById("popup");
      popup.textContent = message;
      popup.className = `popup show ${type}`;
      setTimeout(() => popup.classList.remove('show'), 3000);
      console.log(type === 'success' ? '‚úÖ' : '‚ùå', message);
    }

    function el(id) {
      return document.getElementById(id);
    }

    function goToSignup() {
      window.location.href = "signup.html";
    }

    // ============= SEND OTP =============
    async function sendOTP() {
      try {
        const phone = el("phone").value.trim();

        if (!phone) {
          showPopup("‚ùå ‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç", 'error');
          return;
        }

        if (!/^[6-9]\d{9}$/.test(phone)) {
          showPopup("‚ùå ‡§∏‡§π‡•Ä 10-digit ‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç", 'error');
          return;
        }

        console.log("üîÑ Sending OTP to:", phone);

        el("phone").disabled = true;
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>‡§≠‡•á‡§ú ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...';

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

        const res = await fetch(`${API_BASE_URL}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        const data = await res.json();

        if (data.success) {
          currentPhone = phone;
          showPopup("‚úÖ OTP ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ!");
          el("phoneSection").classList.add("hidden");
          el("otpSection").classList.remove("hidden");
          el("otpInputGroup").querySelector("input").focus();
          console.log("‚úÖ OTP sent to:", data.email);
        } else {
          showPopup("‚ùå " + (data.error || "Error"), 'error');
        }

        el("phone").disabled = false;
        btn.disabled = false;
        btn.innerHTML = "‚úâÔ∏è OTP ‡§≠‡•á‡§ú‡•á‡§Ç";
      } catch (err) {
        console.error("‚ùå Error:", err);
        showPopup("‚ùå Connection error", 'error');
        el("phone").disabled = false;
        event.target.disabled = false;
        event.target.innerHTML = "‚úâÔ∏è OTP ‡§≠‡•á‡§ú‡•á‡§Ç";
      }
    }

    // ============= REGISTER SERVICE WORKER =============
    async function registerServiceWorker() {
      try {
        if (!('serviceWorker' in navigator)) {
          console.warn("‚ö†Ô∏è Service Workers not supported");
          return null;
        }

        const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        console.log("‚úÖ Service Worker registered:", registration);
        return registration;
      } catch (err) {
        console.error("‚ùå Service Worker registration error:", err);
        return null;
      }
    }

    // ============= REQUEST NOTIFICATION PERMISSION =============
    async function askNotificationPermission() {
      try {
        if (!('Notification' in window)) {
          console.warn("‚ö†Ô∏è Notifications not supported");
          return false;
        }

        if (Notification.permission === 'granted') {
          console.log("‚úÖ Notification permission already granted");
          return true;
        }

        if (Notification.permission === 'denied') {
          console.warn("‚ö†Ô∏è Notification permission denied");
          return false;
        }

        const permission = await Notification.requestPermission();
        const granted = permission === 'granted';
        console.log("üîî Notification permission:", permission);
        return granted;
      } catch (err) {
        console.error("‚ùå Permission error:", err);
        return false;
      }
    }

    // ============= SUBSCRIBE TO PUSH NOTIFICATIONS =============
    async function subscribeUser(registration, phone) {
      try {
        console.log("üîî Subscribing user to push notifications...");

        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });

        console.log("‚úÖ Push subscription:", subscription);

        // Send to server
        const res = await fetch(`${API_BASE_URL}/subscribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subscription: subscription.toJSON(),
            phone: phone
          })
        });

        if (res.ok) {
          console.log("‚úÖ Subscribed to notifications");
          localStorage.setItem('pushSubscribed', 'true');
          return true;
        } else {
          console.warn("‚ö†Ô∏è Subscription save failed");
          return false;
        }
      } catch (err) {
        console.error("‚ùå Subscription error:", err);
        return false;
      }
    }

    // ============= HELPER: BASE64 TO UINT8ARRAY =============
    function urlBase64ToUint8Array(base64String) {
      try {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
          .replace(/\-/g, '+')
          .replace(/_/g, '/');

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
      } catch (err) {
        console.error("‚ùå Base64 conversion error:", err);
        return null;
      }
    }

    // ============= VERIFY OTP (WITH NOTIFICATIONS) =============
    async function verifyOTP() {
      try {
        const inputs = document.querySelectorAll(".otp-input");
        const otp = Array.from(inputs).map(i => i.value).join('');

        if (otp.length !== 6) {
          showPopup("‚ùå ‡§∏‡§≠‡•Ä 6 digits ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç", 'error');
          return;
        }

        if (!/^\d{6}$/.test(otp)) {
          showPopup("‚ùå ‡§∏‡§ø‡§∞‡•ç‡§´ numbers ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç", 'error');
          return;
        }

        console.log("üîÑ Verifying OTP:", otp);

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Verify ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...';

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

        const res = await fetch(`${API_BASE_URL}/verify-otp`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone: currentPhone, otp }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        const data = await res.json();

        if (data.success) {
          console.log("‚úÖ OTP verified");
          localStorage.setItem("token", data.token);
          localStorage.setItem("userData", JSON.stringify(data.user));
          
          showPopup("‚úÖ Login ‡§∏‡§´‡§≤!");

          // ============= SETUP NOTIFICATIONS =============
          setTimeout(async () => {
            console.log("üîî Setting up notifications...");
            
            try {
              const registration = await registerServiceWorker();
              if (registration) {
                const granted = await askNotificationPermission();
                if (granted) {
                  const subscribed = await subscribeUser(registration, currentPhone);
                  if (subscribed) {
                    console.log("‚úÖ Notifications setup complete");
                  }
                }
              }
            } catch (err) {
              console.warn("‚ö†Ô∏è Notifications setup failed (non-critical):", err);
            }

            // Redirect after notification setup
            setTimeout(() => {
              window.location.href = "profiles.html";
            }, 1000);
          }, 1500);

        } else {
          otpAttempts++;
          showPopup("‚ùå " + (data.error || "Invalid OTP"), 'error');
          if (otpAttempts >= 3) {
            showPopup("‚ùå ‡§¨‡§π‡•Å‡§§ ‡§∏‡§æ‡§∞‡•á ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏‡•§ ‡§´‡§ø‡§∞ ‡§∏‡•á OTP ‡§≠‡•á‡§ú‡•á‡§Ç", 'error');
            goBackToPhone();
          }
        }

        btn.disabled = false;
        btn.innerHTML = "‚úÖ Verify ‡§ï‡§∞‡•á‡§Ç";
      } catch (err) {
        console.error("‚ùå Error:", err);
        showPopup("‚ùå Connection error", 'error');
        event.target.disabled = false;
        event.target.innerHTML = "‚úÖ Verify ‡§ï‡§∞‡•á‡§Ç";
      }
    }

    // ============= RESEND OTP =============
    async function resendOTP() {
      try {
        console.log("üîÑ Resending OTP to:", currentPhone);

        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>‡§≠‡•á‡§ú ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...';

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

        const res = await fetch(`${API_BASE_URL}/resend-otp`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone: currentPhone }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        const data = await res.json();

        if (data.success) {
          showPopup("‚úÖ ‡§®‡§Ø‡§æ OTP ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ!");
          document.querySelectorAll(".otp-input").forEach(input => input.value = '');
          document.querySelectorAll(".otp-input")[0].focus();
          otpAttempts = 0;
          console.log("‚úÖ OTP resent");
        } else {
          showPopup("‚ùå " + (data.error || "Error"), 'error');
        }

        btn.disabled = false;
        btn.innerHTML = "üîÑ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§≠‡•á‡§ú‡•á‡§Ç";
      } catch (err) {
        console.error("‚ùå Error:", err);
        showPopup("‚ùå Connection error", 'error');
        event.target.disabled = false;
        event.target.innerHTML = "üîÑ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§≠‡•á‡§ú‡•á‡§Ç";
      }
    }

    // ============= GO BACK TO PHONE =============
    function goBackToPhone() {
      el("phoneSection").classList.remove("hidden");
      el("otpSection").classList.add("hidden");
      el("phone").value = '';
      el("phone").focus();
      document.querySelectorAll(".otp-input").forEach(input => input.value = '');
      otpAttempts = 0;
      console.log("‚Ü©Ô∏è Back to phone input");
    }

    // ============= OTP INPUT NAVIGATION =============
    document.addEventListener('DOMContentLoaded', () => {
      const inputs = document.querySelectorAll(".otp-input");

      inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          if (e.target.value && index < inputs.length - 1) {
            inputs[index + 1].focus();
          }
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            inputs[index - 1].focus();
          }
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          if (/^\d{6}$/.test(paste)) {
            paste.split('').forEach((char, i) => {
              if (inputs[i]) inputs[i].value = char;
            });
            inputs[inputs.length - 1].focus();
          }
        });
      });

      // Check if already logged in
      const token = localStorage.getItem("token");
      if (token) {
        window.location.href = "profiles.html";
      }

      console.log("‚úÖ Login page ready");
    });

    // ============= ERROR HANDLING =============
    window.addEventListener('error', (event) => {
      console.error('‚ùå Global error:', event.error);
    });
  </script>
</body>
</html>
