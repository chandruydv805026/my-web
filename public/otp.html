<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Verify OTP - Ratu Fresh</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .otp-container {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(14px);
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      max-width: 400px;
      width: 100%;
      color: #fff;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      text-align: center;
      margin-bottom: 25px;
    }

    .header h2 {
      font-size: 24px;
      font-weight: 600;
      color: #fdfdfd;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
    }

    .otp-info {
      background: rgba(0, 201, 167, 0.1);
      border-left: 3px solid #00c9a7;
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #ccc;
    }

    .otp-info strong {
      color: #92fe9d;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .form-group {
      position: relative;
    }

    input {
      width: 100%;
      padding: 14px;
      border: 2px solid transparent;
      border-radius: 10px;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      outline: none;
      transition: all 0.3s ease;
      letter-spacing: 4px;
      text-align: center;
      font-weight: 600;
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.4);
      letter-spacing: normal;
      font-weight: normal;
    }

    input:focus {
      border-color: #00c9a7;
      background: rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 10px rgba(0, 201, 167, 0.2);
    }

    input.error {
      border-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
    }

    button {
      padding: 14px;
      background: linear-gradient(to right, #00c9a7, #92fe9d);
      color: #222;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 201, 167, 0.4);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .button-text {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .spinner-small {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(34, 34, 34, 0.2);
      border-top: 2px solid #222;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .resend-section {
      margin-top: 15px;
      text-align: center;
    }

    .resend-btn {
      background: none;
      border: 2px solid rgba(0, 201, 167, 0.3);
      color: #00c9a7;
      font-size: 13px;
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s ease;
      font-weight: 500;
      margin-top: 8px;
    }

    .resend-btn:hover:not(:disabled) {
      border-color: #00c9a7;
      background: rgba(0, 201, 167, 0.1);
      color: #92fe9d;
    }

    .resend-btn:disabled {
      color: #666;
      border-color: rgba(102, 102, 102, 0.3);
      cursor: not-allowed;
    }

    .message {
      font-size: 13px;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      display: none;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .error-message {
      background: rgba(255, 107, 107, 0.1);
      color: #ff8787;
      border-left: 3px solid #ff6b6b;
    }

    .error-message.show {
      display: block;
    }

    .success-message {
      background: rgba(146, 254, 157, 0.1);
      color: #92fe9d;
      border-left: 3px solid #00c9a7;
    }

    .success-message.show {
      display: block;
    }

    .timer-info {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 12px;
      text-align: center;
    }

    .timer-info.warning {
      color: #ffb347;
    }

    .back-link {
      text-align: center;
      margin-top: 15px;
    }

    .back-link a {
      color: #00c9a7;
      text-decoration: none;
      font-size: 12px;
      cursor: pointer;
    }

    .back-link a:hover {
      text-decoration: underline;
      color: #92fe9d;
    }

    @media (max-width: 480px) {
      .otp-container {
        padding: 20px 15px;
        border-radius: 12px;
      }

      .header h2 {
        font-size: 20px;
      }

      input {
        padding: 12px;
        font-size: 14px;
      }

      button {
        padding: 12px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="otp-container">
    <div class="header">
      <h2>üîê Verify OTP</h2>
      <p>Enter the 6-digit code sent to your email</p>
    </div>

    <div class="otp-info" id="emailInfo">
      üì© OTP ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à...
    </div>

    <form id="otpForm" novalidate>
      <div class="form-group">
        <input 
          type="text" 
          id="otpInput"
          placeholder="000000" 
          maxlength="6" 
          required 
          inputmode="numeric"
          autocomplete="one-time-code"
        />
      </div>

      <button type="submit" id="submitBtn">
        <span class="button-text">
          <span id="buttonText">Verify OTP</span>
          <span id="spinner" class="spinner-small" style="display: none;"></span>
        </span>
      </button>

      <div class="message error-message" id="errorMsg"></div>
      <div class="message success-message" id="successMsg"></div>
      <div class="timer-info" id="timerInfo"></div>
    </form>

    <div class="resend-section">
      <button class="resend-btn" id="resendBtn" disabled>
        üîÅ Resend OTP (<span id="countdown">30</span>s)
      </button>
    </div>

    <div class="back-link">
      <a onclick="goBackToLogin()">‚Üê Back to Login</a>
    </div>
  </div>

  <script>
    // ============= CONSTANTS =============
    const API_BASE_URL = 'https://my-web-xrr5.onrender.com';
    const REQUEST_TIMEOUT = 10000;
    const OTP_LENGTH = 6;
    const RESEND_COOLDOWN = 30;

    // ============= DOM ELEMENTS =============
    const form = document.getElementById('otpForm');
    const otpInput = document.getElementById('otpInput');
    const submitBtn = document.getElementById('submitBtn');
    const resendBtn = document.getElementById('resendBtn');
    const emailInfo = document.getElementById('emailInfo');
    const errorMsg = document.getElementById('errorMsg');
    const successMsg = document.getElementById('successMsg');
    const timerInfo = document.getElementById('timerInfo');
    const buttonText = document.getElementById('buttonText');
    const spinner = document.getElementById('spinner');
    const countdownSpan = document.getElementById('countdown');

    // ============= STATE VARIABLES =============
    let phone = localStorage.getItem("phone");
    let email = localStorage.getItem("otpEmail");
    let countdown = RESEND_COOLDOWN;
    let isSubmitting = false;
    let otpExpiryTime = null;

    // ============= UTILITY FUNCTIONS =============
    function maskEmail(email) {
      if (!email || !email.includes('@')) return 'your email';
      
      const [local, domain] = email.split("@");
      if (local.length <= 2) {
        return local[0] + "*@" + domain;
      }
      
      const first = local.slice(0, 2);
      const last = local.slice(-1);
      const masked = "*".repeat(local.length - 3);
      return `${first}${masked}${last}@${domain}`;
    }

    function showError(message) {
      errorMsg.textContent = message;
      errorMsg.classList.add('show');
      successMsg.classList.remove('show');
      console.error("‚ùå", message);
    }

    function showSuccess(message) {
      successMsg.textContent = message;
      successMsg.classList.add('show');
      errorMsg.classList.remove('show');
      console.log("‚úÖ", message);
    }

    function hideMessages() {
      errorMsg.classList.remove('show');
      successMsg.classList.remove('show');
    }

    function setLoading(isLoading) {
      submitBtn.disabled = isLoading;
      spinner.style.display = isLoading ? 'inline-block' : 'none';
      buttonText.textContent = isLoading ? 'Verifying...' : 'Verify OTP';
      otpInput.disabled = isLoading;
    }

    function validateOTP(otp) {
      if (!otp) return 'OTP ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à';
      if (otp.length !== OTP_LENGTH) return `‡§ï‡•É‡§™‡§Ø‡§æ ${OTP_LENGTH} ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ OTP ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç`;
      if (!/^\d{6}$/.test(otp)) return '‡§ï‡•á‡§µ‡§≤ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ‡§è‡§Ç ‡§™‡•ç‡§∞‡§µ‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç';
      return null;
    }

    function updateTimerInfo() {
      if (!otpExpiryTime) return;

      const now = new Date();
      const timeLeft = Math.max(0, Math.floor((otpExpiryTime - now) / 1000));

      if (timeLeft <= 0) {
        timerInfo.textContent = '‚è∞ OTP ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ó‡§Ø‡§æ‡•§ ‡§®‡§Ø‡§æ OTP ‡§≠‡•á‡§ú‡•á‡§Ç‡•§';
        timerInfo.classList.add('warning');
        submitBtn.disabled = true;
      } else if (timeLeft <= 30) {
        timerInfo.textContent = `‚è∞ OTP ${timeLeft}s ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§ ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ`;
        timerInfo.classList.add('warning');
      } else {
        timerInfo.textContent = '';
        timerInfo.classList.remove('warning');
      }
    }

    function startOTPTimer() {
      otpExpiryTime = new Date(Date.now() + 2 * 60 * 1000); // 2 minutes
      const timerInterval = setInterval(() => {
        updateTimerInfo();
        if (!otpExpiryTime || new Date() > otpExpiryTime) {
          clearInterval(timerInterval);
        }
      }, 1000);
      updateTimerInfo();
    }

    function goBackToLogin() {
      if (confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ login page ‡§™‡§∞ ‡§ú‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) {
        localStorage.removeItem('phone');
        localStorage.removeItem('otpEmail');
        window.location.href = 'login.html';
      }
    }

    function saveLoginData(token, user) {
      try {
        localStorage.setItem("token", token);
        localStorage.setItem("userData", JSON.stringify(user));
        localStorage.setItem("loginTime", new Date().toISOString());
        console.log("‚úÖ Login data saved");
        return true;
      } catch (err) {
        console.error("‚ùå Storage error:", err);
        return false;
      }
    }

    // ============= INITIALIZATION =============
    function initialize() {
      console.log("üîç Initializing OTP page...");
      console.log("üì± Phone:", phone);
      console.log("üìß Email:", email);

      if (!phone) {
        showError('‚ùå Phone number ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ ‡§´‡§ø‡§∞ ‡§∏‡•á login ‡§ï‡§∞‡•á‡§Ç‡•§');
        submitBtn.disabled = true;
        resendBtn.disabled = true;
        setTimeout(() => goBackToLogin(), 3000);
        return;
      }

      // Display email info
      if (email) {
        emailInfo.innerHTML = `üì© OTP ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à: <strong>${maskEmail(email)}</strong>`;
      } else {
        emailInfo.innerHTML = 'üì© OTP ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à ‡§Ü‡§™‡§ï‡•á ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§à‡§Æ‡•á‡§≤ ‡§™‡§∞';
      }

      // Start OTP expiry timer
      startOTPTimer();

      // Start resend cooldown
      updateResendButton();

      // Focus on input
      otpInput.focus();
    }

    // ============= OTP INPUT HANDLING =============
    otpInput.addEventListener('input', (e) => {
      // Allow only digits
      e.target.value = e.target.value.replace(/\D/g, '').slice(0, OTP_LENGTH);
      
      // Auto-submit when 6 digits entered
      if (e.target.value.length === OTP_LENGTH) {
        console.log("‚úÖ 6 digits entered, auto-submitting...");
        // Small delay to let user see the input
        setTimeout(() => form.dispatchEvent(new Event('submit')));
      }

      // Hide error on input
      hideMessages();
      otpInput.classList.remove('error');
    });

    otpInput.addEventListener('blur', () => {
      if (otpInput.value) {
        const error = validateOTP(otpInput.value);
        if (error) {
          otpInput.classList.add('error');
          showError(error);
        }
      }
    });

    // ============= FORM SUBMISSION =============
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (isSubmitting) return;

      const otp = otpInput.value.trim();

      // Validation
      const validationError = validateOTP(otp);
      if (validationError) {
        otpInput.classList.add('error');
        showError(validationError);
        return;
      }

      if (!phone) {
        showError('‚ùå Phone number ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ');
        return;
      }

      isSubmitting = true;
      hideMessages();
      setLoading(true);

      console.log("üîÑ Verifying OTP:", otp.replace(/./g, '*'), "for phone:", phone);

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

        const res = await fetch(`${API_BASE_URL}/verify-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone, otp }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        const result = await res.json();
        console.log("üìä Server response status:", res.status);

        if (res.ok && result.success) {
          console.log("‚úÖ OTP verified successfully");

          // Save login data
          const saved = saveLoginData(result.token, result.user);
          if (!saved) {
            showError('‚ùå Storage error. Try again.');
            setLoading(false);
            isSubmitting = false;
            return;
          }

          showSuccess('‚úÖ OTP ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§! ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...');

          setTimeout(() => {
            console.log("üîÑ Redirecting to profiles page...");
            window.location.href = 'profiles.html';
          }, 1500);
        } else {
          const errorText = result.error || '‚ùå OTP ‡§ó‡§≤‡§§ ‡§π‡•à‡•§ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§';
          showError(errorText);
          otpInput.classList.add('error');
          setLoading(false);
          isSubmitting = false;
        }
      } catch (err) {
        console.error('‚ùå Request error:', err);

        let errorMessage = '‚ùå ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø';
        if (err.name === 'AbortError') {
          errorMessage = '‚ùå Request timeout - ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç';
        } else if (err instanceof TypeError) {
          errorMessage = '‚ùå ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø - ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç';
        }

        showError(errorMessage);
        setLoading(false);
        isSubmitting = false;
      }
    });

    // ============= RESEND OTP =============
    function updateResendButton() {
      resendBtn.textContent = `üîÅ Resend OTP (${countdown}s)`;
      resendBtn.disabled = true;

      const interval = setInterval(() => {
        countdown--;
        countdownSpan.textContent = countdown;

        if (countdown <= 0) {
          resendBtn.textContent = 'üîÅ Resend OTP';
          resendBtn.disabled = false;
          clearInterval(interval);
        }
      }, 1000);
    }

    resendBtn.addEventListener('click', async (e) => {
      e.preventDefault();

      if (!phone) {
        showError('‚ùå Phone number ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ');
        return;
      }

      resendBtn.disabled = true;
      console.log("üîÑ Requesting new OTP for phone:", phone);

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

        const res = await fetch(`${API_BASE_URL}/resend-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        const result = await res.json();
        console.log("üìä Resend response:", result);

        if (res.ok && result.success) {
          showSuccess('‚úÖ ‡§®‡§Ø‡§æ OTP ‡§≠‡•á‡§ú ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ');
          countdown = RESEND_COOLDOWN;
          updateResendButton();
          otpInput.value = '';
          otpInput.focus();
          startOTPTimer();
        } else {
          showError(result.error || '‚ùå OTP ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ');
          resendBtn.disabled = false;
        }
      } catch (err) {
        console.error('‚ùå Resend error:', err);

        let errorMessage = '‚ùå ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø';
        if (err.name === 'AbortError') {
          errorMessage = '‚ùå Request timeout';
        }

        showError(errorMessage);
        resendBtn.disabled = false;
      }
    });

    // ============= PAGE LOAD =============
    document.addEventListener('DOMContentLoaded', () => {
      console.log("‚úÖ OTP page loaded");
      initialize();
    });

    // ============= ERROR HANDLING =============
    window.addEventListener('error', (event) => {
      console.error('‚ùå Global error:', event.error);
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('‚ùå Unhandled rejection:', event.reason);
    });

    // Clear data on page unload if not verified
    window.addEventListener('beforeunload', (e) => {
      if (!localStorage.getItem('token') && localStorage.getItem('phone')) {
        console.log("üîÑ Clearing OTP session on page unload");
      }
    });
  </script>
</body>
</html>
